<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surah Walk (Demo)</title>
  <style>
    :root{
      --bg:#064e3b;        /* dark emerald */
      --gold:#d4af37;      /* gold */
      --muted:#cbd5e1;     /* slate-ish */
      --muted2:#94a3b8;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{background:var(--bg);color:white;display:flex;align-items:center;justify-content:center;}
    .wrap{width:min(900px, 92vw);height:min(720px, 92vh);position:relative;}
    .corner{
      position:absolute;top:14px;left:14px;
      font-size:14px;color:var(--muted);
      letter-spacing:.2px;
      user-select:none;
    }
    .corner b{color:white;font-weight:650}
    .center{
      position:absolute;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      text-align:center;
      user-select:none;
    }
    .arabic{
      font-size:56px;line-height:1.25;
      color:var(--gold);
      padding:0 10px;
      direction:rtl;
      font-family: "Amiri", "Scheherazade New", "Noto Naskh Arabic", serif;
    }
    .subrow{
      margin-top:18px;
      display:flex;gap:14px;align-items:center;justify-content:center;
      color:var(--muted);
      font-size:16px;
      min-height:28px;
    }
    .pill{
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
    }
    .hint{
      position:absolute;bottom:14px;left:50%;transform:translateX(-50%);
      color:rgba(255,255,255,.75);font-size:13px;
      user-select:none;
    }
    .screen{
      position:absolute;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:18px;
    }
    .card{
      width:min(520px, 86vw);
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.18);
      border-radius:20px;
      padding:18px 16px;
    }
    .title{
      font-size:20px;font-weight:700;letter-spacing:.2px;
      margin:0 0 6px 0;
    }
    .small{color:var(--muted);font-size:14px;margin:0}
    img.basmalah{
      max-width:280px;width:60%;
      height:auto;display:block;margin:0 auto 10px auto;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.25));
      border-radius:12px;
      background:rgba(255,255,255,.06);
      padding:10px;
    }
    .btn{
      display:inline-block;
      margin-top:10px;
      border:1px solid rgba(255,255,255,.22);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(0,0,0,.16);
      cursor:pointer;
      color:white;
      user-select:none;
    }
    .loadingbar{
      height:8px;border-radius:999px;overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
      margin-top:10px;
    }
    .loadingbar > div{
      height:100%;width:0%;
      background:rgba(212,175,55,.85);
      transition:width .2s ease;
    }
    .err{color:#fecaca}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="screen" id="splash">
      <div class="card">
        <img
          class="basmalah"
          alt="Basmala calligraphy"
          src="https://upload.wikimedia.org/wikipedia/commons/2/2c/Bismillah.svg"
        />
        <p class="title">Surah Walk</p>
        <p class="small" id="splashLine">Randomly choosing a surahâ€¦</p>
        <div class="loadingbar" aria-hidden="true"><div id="bar"></div></div>
        <div class="btn" id="startBtn">Start</div>
        <p class="small" style="margin-top:10px;color:var(--muted2)">
          Tap anywhere to advance word-by-word. ğŸ”Š = transliteration, ğŸŒ = meaning.
        </p>
      </div>
    </div>

    <div class="corner" id="corner" style="display:none">
      <b id="cornerRef">â€“</b> Â· <span id="cornerProg">â€“</span>
    </div>

    <div class="center" id="reader" style="display:none">
      <div class="arabic" id="word">â€¦</div>

      <div class="subrow">
        <div class="pill" id="tglPron" title="Toggle pronunciation">ğŸ”Š</div>
        <div class="pill" id="tglMean" title="Toggle meaning">ğŸŒ</div>
      </div>

      <div class="subrow" style="margin-top:8px">
        <div id="pron" style="display:none"></div>
      </div>
      <div class="subrow" style="margin-top:0">
        <div id="mean" style="display:none"></div>
      </div>

      <div class="hint">Tap/click anywhere to reveal the next word</div>
    </div>
  </div>

<script>
(() => {
  // Quran.com API (v4) â€œverses by chapterâ€ endpoint is commonly used like:
  // https://api.quran.com/api/v4/verses/by_chapter/1?language=en&words=true&page=1&per_page=10  (example)
  // We'll fetch per_page=50 and paginate until done.
  const API_BASE = "https://api.quran.com/api/v4";

  const el = (id) => document.getElementById(id);

  const splash = el("splash");
  const splashLine = el("splashLine");
  const startBtn = el("startBtn");
  const bar = el("bar");

  const corner = el("corner");
  const cornerRef = el("cornerRef");
  const cornerProg = el("cornerProg");

  const reader = el("reader");
  const wordEl = el("word");
  const tglPron = el("tglPron");
  const tglMean = el("tglMean");
  const pronEl = el("pron");
  const meanEl = el("mean");

  // State
  let chapterNumber = null;
  let wordsFlat = []; // [{arabic, translit, meaning, verse_key, wIndexInVerse, wCountInVerse, globalIndex, globalTotal}]
  let idx = 0;
  let showPron = false;
  let showMean = false;
  let started = false;

  function cryptoRandomInt(minInclusive, maxInclusive){
    const span = maxInclusive - minInclusive + 1;
    const buf = new Uint32Array(1);
    crypto.getRandomValues(buf);
    return minInclusive + (buf[0] % span);
  }

  async function fetchAllVersesByChapter(chNum){
    const perPage = 50;
    let page = 1;
    let all = [];
    while(true){
      const url = `${API_BASE}/verses/by_chapter/${chNum}?language=en&words=true&page=${page}&per_page=${perPage}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" }});
      if(!res.ok){
        throw new Error(`API error ${res.status} on page ${page}`);
      }
      const data = await res.json();
      if(!data || !data.verses) throw new Error("Unexpected API response.");
      all = all.concat(data.verses);

      // Progress bar (rough, based on pages)
      const totalPages = (data.pagination && data.pagination.total_pages) ? Number(data.pagination.total_pages) : null;
      if(totalPages){
        bar.style.width = `${Math.min(100, Math.round((page/totalPages)*100))}%`;
      } else {
        bar.style.width = `${Math.min(95, page*10)}%`;
      }

      const nextPage = data.pagination && data.pagination.next_page ? Number(data.pagination.next_page) : null;
      if(!nextPage) break;
      page = nextPage;
    }
    bar.style.width = "100%";
    return all;
  }

  function flattenWords(verses){
    const out = [];
    for(const v of verses){
      const verseKey = v.verse_key || `${v.chapter_id}:${v.verse_number}`;
      const words = Array.isArray(v.words) ? v.words : [];
      const count = words.length;
      let wIndex = 0;
      for(const w of words){
        if(w.char_type_name && w.char_type_name !== "word") continue; // skip pause marks etc.
        wIndex += 1;
        out.push({
          arabic: w.text_uthmani || "",
          translit: (w.transliteration && w.transliteration.text) ? w.transliteration.text : "",
          meaning: (w.translation && w.translation.text) ? w.translation.text : "",
          verse_key: verseKey,
          wIndexInVerse: wIndex,
          wCountInVerse: count
        });
      }
    }
    // Add global counters
    const total = out.length;
    out.forEach((x,i) => {
      x.globalIndex = i+1;
      x.globalTotal = total;
    });
    return out;
  }

  function render(){
    const cur = wordsFlat[idx];
    if(!cur){
      wordEl.textContent = "âœ“";
      pronEl.textContent = "";
      meanEl.textContent = "";
      cornerRef.textContent = `${chapterNumber}:end`;
      cornerProg.textContent = `done`;
      return;
    }

    wordEl.textContent = cur.arabic || "â€¦";
    cornerRef.textContent = cur.verse_key;
    cornerProg.textContent = `${cur.globalIndex}/${cur.globalTotal}`;

    pronEl.style.display = showPron ? "block" : "none";
    meanEl.style.display = showMean ? "block" : "none";

    pronEl.textContent = showPron ? (cur.translit || "â€”") : "";
    meanEl.textContent = showMean ? (cur.meaning || "â€”") : "";
  }

  function nextWord(){
    if(!started) return;
    if(idx < wordsFlat.length) idx += 1;
    render();
  }

  function togglePron(ev){
    ev.stopPropagation();
    showPron = !showPron;
    render();
  }
  function toggleMean(ev){
    ev.stopPropagation();
    showMean = !showMean;
    render();
  }

  async function init(){
    // Choose random surah 1..114 using cryptographic randomness in the browser.
    chapterNumber = cryptoRandomInt(1,114);
    splashLine.textContent = `Random surah selected: ${chapterNumber}. Fetchingâ€¦`;

    const verses = await fetchAllVersesByChapter(chapterNumber);
    wordsFlat = flattenWords(verses);

    splashLine.textContent = `Ready. Surah ${chapterNumber} Â· ${wordsFlat.length} words`;
  }

  function start(){
    started = true;
    splash.style.display = "none";
    corner.style.display = "block";
    reader.style.display = "block";
    idx = 0;
    showPron = false;
    showMean = false;
    render();
  }

  // Events
  document.addEventListener("click", () => nextWord());
  document.addEventListener("touchstart", () => nextWord(), {passive:true});
  tglPron.addEventListener("click", togglePron);
  tglMean.addEventListener("click", toggleMean);
  startBtn.addEventListener("click", (ev) => { ev.stopPropagation(); start(); });

  // Boot
  (async () => {
    try{
      await init();
    } catch(e){
      splashLine.innerHTML = `<span class="err">Couldnâ€™t load the surah (${String(e.message || e)}).</span><br><span class="small">You need an internet connection, and the API must allow your browser (CORS).</span>`;
      startBtn.textContent = "Retry";
      startBtn.onclick = async (ev) => {
        ev.stopPropagation();
        bar.style.width = "0%";
        splashLine.textContent = "Retryingâ€¦";
        try{ await init(); } catch(err){ splashLine.textContent = String(err.message || err); }
      };
      return;
    }
  })();
})();
</script>
</body>
</html>
